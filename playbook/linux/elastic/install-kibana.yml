
- name: Install Kibana
  hosts: elastic

  tasks:
          - name: Install Elastic GPG Key
            become: true
            apt_key:
                    url: "https://artifacts.elastic.co/GPG-KEY-elasticsearch"
                    state: present
                    id: 46095ACC8548582C1A2699A9D27D666CD88E42B4

          - name: Install apt-transport-https
            apt:
                    name: apt-transport-https

          - name: Add Elastic Repo
            become: true
            copy:
                    src: elastic-7.x.list
                    dest: /etc/apt/sources.list.d/
                    backup: yes

          - name: Update Packages
            become: true
            apt:
                    update_cache: true

          - name: Install kibana
            become: true
            apt:
                    name: kibana
         
          - name: Update kibana config
            become: true
            copy:
                    src: kibana.yml
                    dest: /etc/kibana/
                    backup: yes

          - name: Allow port 5601
            become: true
            ufw:
                    rule: allow
                    port: 5601

          - name: Service daemon reload
            become: true
            systemd:
                    daemon_reload: yes

          - name: Start Kibana 
            become: true
            systemd:
                    name: kibana.service
                    enabled: yes
                    state: started

